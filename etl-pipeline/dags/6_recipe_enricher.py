import json
import logging
from datetime import datetime, timedelta
from airflow.decorators import dag, task
from airflow.providers.postgres.hooks.postgres import PostgresHook
from utils.ai import ask_ai_json

PG_CONN_ID = "recipe_db_postgres"
BATCH_SIZE = 5       
CONCURRENCY = 20      

logger = logging.getLogger("airflow.task")

@dag(
    dag_id="6_recipe_enricher",
    start_date=datetime(2023, 1, 1),
    schedule=None,
    catchup=False,
    tags=["enrichment", "ai", "recipes"],
    max_active_tasks=CONCURRENCY,
    default_args={"retries": 1, "retry_delay": timedelta(minutes=1)}
)
def recipe_enricher():

    @task(retries=3, retry_delay=timedelta(seconds=30))
    def worker_task(worker_id: int):
        pg_hook = PostgresHook(postgres_conn_id=PG_CONN_ID)
        conn = pg_hook.get_conn()
        cursor = conn.cursor()

        logger.info(f"Worker #{worker_id} started.")
        # --- 0. –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø PYTHON-–í–ê–õ–Ü–î–ê–¢–û–†–ê (SAFETY NET) ---
        
        # 1. –ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ –∫–æ—Ä–µ–Ω—ñ (–≤ –Ω–∏–∂–Ω—å–æ–º—É —Ä–µ–≥—ñ—Å—Ç—Ä—ñ!)
        STOP_ROOTS = {
            "–í–µ–≥–∞–Ω": [
                "—Å–≤–∏–Ω", "—è–ª–æ–≤–∏—á", "—Ç–µ–ª—è—Ç", "–∫—É—Ä—è—á", "–∫—É—Ä–∫", "—Ñ—ñ–ª–µ –∫—É—Ä", "—ñ–Ω–¥–∏—á", "–∫–∞—á–∫", "–∫—Ä–æ–ª", "–º'—è—Å", "–º—è—Å", 
                "—Ä–∏–±", "–æ—Å–µ–ª–µ–¥–µ—Ü", "–ª–æ—Å–æ—Å", "—Ñ–æ—Ä–µ–ª", "—â—É–∫", "—Å–æ–º", "—Ç—É–Ω", "–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç", "–∫—Ä–µ–≤–µ—Ç–∫", 
                "—è–π—Ü", "–∂–æ–≤—Ç", "–±—ñ–ª–æ–∫", "–æ–º–ª–µ—Ç", "–º–µ–ª–∞–Ω–∂", 
                "–º–µ–¥", "–±–¥–∂–æ–ª–∏–Ω",
                "–º–æ–ª–æ–∫", "–≤–µ—Ä—à–∫", "—Å–º–µ—Ç–∞–Ω", "–º–∞—Å–ª", "—Å–∏—Ä", "–∫–µ—Ñ—ñ—Ä", "—Ä—è–∂–∞–Ω–∫", "–π–æ–≥—É—Ä—Ç", "—Å–∏—Ä–æ–≤–∞—Ç–∫", 
                "–∂–µ–ª–∞—Ç–∏–Ω"
            ],
            "–í–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–µ": [
                "—Å–≤–∏–Ω", "—è–ª–æ–≤–∏—á", "—Ç–µ–ª—è—Ç", "–∫—É—Ä—è—á", "–∫—É—Ä–∫", "—Ñ—ñ–ª–µ –∫—É—Ä", "—ñ–Ω–¥–∏—á", "–∫–∞—á–∫", "–∫—Ä–æ–ª", "–º'—è—Å", "–º—è—Å",
                "—Ä–∏–±", "–æ—Å–µ–ª–µ–¥–µ—Ü", "–ª–æ—Å–æ—Å", "—Ñ–æ—Ä–µ–ª", "—â—É–∫", "—Å–æ–º", "—Ç—É–Ω", "–º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç", "–∫—Ä–µ–≤–µ—Ç–∫",
                "–∂–µ–ª–∞—Ç–∏–Ω", "—Å–∞–ª–æ", "—à–∏–Ω–∫", "–±–µ–∫–æ–Ω", "–∫–æ–≤–±–∞—Å", "—Å–æ—Å–∏—Å", "–ø–∞—à—Ç–µ—Ç", "—Ç—É—à–æ–Ω–∫"
            ],
            "–ü—ñ—Å–Ω–µ": [
                "—Å–≤–∏–Ω", "—è–ª–æ–≤–∏—á", "—Ç–µ–ª—è—Ç", "–∫—É—Ä—è—á", "–∫—É—Ä–∫", "—Ñ—ñ–ª–µ –∫—É—Ä", "—ñ–Ω–¥–∏—á", "–∫–∞—á–∫", "–∫—Ä–æ–ª", "–º'—è—Å", "–º—è—Å",
                "—è–π—Ü", "–∂–æ–≤—Ç", "–æ–º–ª–µ—Ç",
                "–º–æ–ª–æ–∫", "–≤–µ—Ä—à–∫", "—Å–º–µ—Ç–∞–Ω", "–º–∞—Å–ª", "—Å–∏—Ä", "–∫–µ—Ñ—ñ—Ä", "–π–æ–≥—É—Ä—Ç",
                "—Å–∞–ª–æ", "—à–∏–Ω–∫", "–±–µ–∫–æ–Ω", "–∫–æ–≤–±–∞—Å"
            ],
            "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω—É": [
                "–ø—à–µ–Ω–∏—Ü", "–ø—à–µ–Ω–∏—á–Ω", "–∂–∏—Ç–Ω", "–∂–∏—Ç", "—è—á–º—ñ–Ω", "–ø–µ—Ä–ª–æ–≤", 
                "–±–æ—Ä–æ—à–Ω", "—Ö–ª—ñ–±", "—Å—É—Ö–∞—Ä", "–±–∞—Ç–æ–Ω", "–±—É–ª–∫", "–ª–∞–≤–∞—à", 
                "–º–∞–∫–∞—Ä–æ–Ω", "—Å–ø–∞–≥–µ—Ç", "–ª–æ–∫—à–∏–Ω", "–≤–µ—Ä–º—ñ—à–µ–ª", 
                "–º–∞–Ω–∫–∞", "–º–∞–Ω–Ω", "–∫—É—Å-–∫—É—Å", "–±—É–ª–≥—É—Ä"
            ],
            "–ö–µ—Ç–æ": [
                "—Ü—É–∫–æ—Ä", "–ø—É–¥—Ä", "—Å–∏—Ä–æ–ø", "–º–µ–¥", "–≤–∞—Ä–µ–Ω–Ω", "–¥–∂–µ–º",
                "–∫–∞—Ä—Ç–æ–ø–ª", "—Ä–∏—Å", "–≥—Ä–µ—á–∫", "–≤—ñ–≤—Å—è–Ω", "–∫—É–∫—É—Ä—É–¥–∑", 
                "–±–æ—Ä–æ—à–Ω", "—Ö–ª—ñ–±", "–±–∞–Ω–∞–Ω", "–≤–∏–Ω–æ–≥—Ä–∞–¥"
            ],
            "–ë–µ–∑ —Ü—É–∫—Ä—É": [
                "—Ü—É–∫–æ—Ä", "—Ü—É–∫—Ä–æ–≤", "–ø—É–¥—Ä", "—Å–∏—Ä–æ–ø", "–º–µ–¥", "–∑–≥—É—â–µ–Ω", "—à–æ–∫–æ–ª–∞–¥", "—Ü—É–∫–µ—Ä–∫"
            ]
        }

        # 2. –í–∏–∫–ª—é—á–µ–Ω–Ω—è (–Ø–∫—â–æ –ø–µ—Ä–µ–¥ –∫–æ—Ä–µ–Ω–µ–º —Å—Ç–æ—ó—Ç—å —Ü–µ - —Ç–æ –¥–æ–∑–≤–æ–ª—è—î–º–æ)
        ALLOW_CONTEXT = {
            "–º–æ–ª–æ–∫": ["–∫–æ–∫–æ—Å", "–º–∏–≥–¥–∞–ª", "—Å–æ—î–≤", "–≤—ñ–≤—Å—è–Ω", "—Ä–æ—Å–ª–∏–Ω", "—Å—É—Ö"],
            "–º–∞—Å–ª": ["—Ä–æ—Å–ª–∏–Ω", "–æ–ª–∏–≤–∫", "—Å–æ–Ω—è—à–Ω–∏–∫", "–∫—É–∫—É—Ä—É–¥–∑", "–∫–æ–∫–æ—Å", "–∫–∞–∫–∞–æ", "–ª–ª—è–Ω–µ", "–∫—É–Ω–∂—É—Ç", "–≥–∞—Ä–±—É–∑"],
            "—Å–∏—Ä": ["—Ç–æ—Ñ—É", "—Å–æ—î–≤"], 
            "–≤–µ—Ä—à–∫": ["–∫–æ–∫–æ—Å", "—Ä–æ—Å–ª–∏–Ω"],
            "–±–æ—Ä–æ—à–Ω": ["—Ä–∏—Å–æ", "–∫—É–∫—É—Ä—É–¥–∑", "–≥—Ä–µ—á–∞–Ω", "–º–∏–≥–¥–∞–ª", "–∫–æ–∫–æ—Å", "–ª–ª—è–Ω–µ", "–Ω—É—Ç"],
            "–±—ñ–ª–æ–∫": ["—Ä–æ—Å–ª–∏–Ω", "—Å–æ—î–≤", "–≥–æ—Ä–æ—Ö"],
            # üî• –í–ê–ñ–õ–ò–í–û: –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ "–ì—Ä–∏–±—ñ–≤" (–∫–æ—Ä—ñ–Ω—å '—Ä–∏–±')
            "—Ä–∏–±": ["–≥", "–±—ñ–ª–∏–π –≥", "—Å—É—à–µ–Ω–∏–π –≥"], 
            # üî• –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–æ–∑–≤–æ–ª—è—î–º–æ "–ñ–æ–≤—Ç—É" —Ü–∏–±—É–ª—é/–ø–µ—Ä–µ—Ü/—Ç–æ–º–∞—Ç–∏
            "–∂–æ–≤—Ç": ["—Ü–∏–±—É–ª", "–ø–µ—Ä–µ—Ü", "—Ç–æ–º–∞—Ç", "–ø–æ–º—ñ–¥–æ—Ä", "—á–µ—Ä–µ—à–Ω", "—Å–ª–∏–≤", "–∫–∞–≤—É–Ω", "–¥–∏–Ω"],
            # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ "–ö—É—Ä–∫—É–º–∏" —Ç–∞ "–ö—É—Ä–∞–≥–∏" - —è –ø—Ä–∏–±—Ä–∞–≤ –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ—Ä—ñ–Ω—å "–∫—É—Ä", —Ç–æ–º—É —Ç—É—Ç –±–µ–∑–ø–µ—á–Ω–æ

            # üî• –ù–û–í–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–æ–∑–≤–æ–ª—è—î–º–æ "–∫—É—Ä—è—á—ñ" —è–π—Ü—è –¥–ª—è –≤–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Ü—ñ–≤
            "–∫—É—Ä—è—á": ["—è–π—Ü"], 
            "–∫—É—Ä": ["—è–π—Ü"],
            # üî• –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: "–°–∏—Ä–æ–ø" –º—ñ—Å—Ç–∏—Ç—å "—Å–∏—Ä", —Ç–æ–º—É –¥–æ–∑–≤–æ–ª—è—î–º–æ "–∫–ª–µ–Ω–æ–≤–∏–π/—Ü—É–∫—Ä–æ–≤–∏–π —Å–∏—Ä(–æ–ø)"
            "—Å–∏—Ä": ["—Ç–æ—Ñ—É", "—Å–æ—î–≤", "–∫–ª–µ–Ω–æ–≤–∏–π", "—Ü—É–∫—Ä–æ–≤", "–∫—É–∫—É—Ä—É–¥–∑", "—ñ–Ω–≤–µ—Ä—Ç–Ω–∏–π", "–≥–ª—é–∫–æ–∑–Ω–∏–π"]
        }

        def validate_diet_tag(tag, text_lower):
            """
            –ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏—Ö —Å–ª—ñ–≤. 
            text_lower - —Ü–µ –≤–∂–µ —Ç–µ–∫—Å—Ç —É –Ω–∏–∂–Ω—å–æ–º—É —Ä–µ–≥—ñ—Å—Ç—Ä—ñ (—Ç–æ–º—É "–Ø–π—Ü—è" -> "—è–π—Ü—è").
            """
            roots = STOP_ROOTS.get(tag, [])
            for root in roots:
                if root in text_lower:
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–∏–∫–ª—é—á–µ–Ω–Ω—è (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–ª—ñ–≤–∞)
                    if root in ALLOW_CONTEXT:
                        idx = text_lower.find(root)
                        # –î–∏–≤–∏–º–æ—Å—å 10 —Å–∏–º–≤–æ–ª—ñ–≤ –∑–ª—ñ–≤–∞ (–Ω–∞–ø—Ä. "–∫–æ–∫–æ—Å–æ–≤–µ [–º–æ–ª–æ–∫]–æ")
                        context = text_lower[max(0, idx - 10):idx]
                        
                        # –Ø–∫—â–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ —î –¥–æ–∑–≤–æ–ª–µ–Ω–µ —Å–ª–æ–≤–æ - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ü–µ–π root
                        if any(allow in context for allow in ALLOW_CONTEXT[root]):
                            continue 
                    
                    # –Ø–∫—â–æ –¥—ñ–π—à–ª–∏ —Å—é–¥–∏ - –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ —Å–ª–æ–≤–æ –±–µ–∑ –¥–æ–∑–≤–æ–ª–µ–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                    return False
            return True

        # --- 0. –û–¢–†–ò–ú–£–Ñ–ú–û –°–ü–ò–°–û–ö –í–°–Ü–• –°–í–Ø–¢ –ó –ë–î (–î–ò–ù–ê–ú–Ü–ß–ù–û) ---
        # –©–æ–± –∑–≥–æ–¥—É–≤–∞—Ç–∏ —ó—Ö AI –≤ –ø—Ä–æ–º–ø—Ç
        cursor.execute("SELECT name FROM tags WHERE type = 'occasion'")
        db_occasions = [row[0] for row in cursor.fetchall()]
        # –§–æ—Ä–º—É—î–º–æ —Ä—è–¥–æ–∫ —Ç–∏–ø—É: '–†—ñ–∑–¥–≤–æ', '–ù–æ–≤–∏–π –†—ñ–∫', '–í–µ–ª–∏–∫–¥–µ–Ω—å'
        occasions_prompt_list = ", ".join([f"'{x}'" for x in db_occasions])

        while True:
            # --- 1. –ó–ê–ë–ò–†–ê–Ñ–ú–û –†–û–ë–û–¢–£ ---
            cursor.execute(f"""
                UPDATE recipe_queue
                SET status = 'TAGGING_PROCESSING', 
                    updated_at = NOW(),
                    error_message = NULL
                WHERE url IN (
                    SELECT url FROM recipe_queue
                    WHERE status = 'OPTIONAL_DONE' 
                       OR status = 'TAGGING_ERROR'
                    LIMIT {BATCH_SIZE}
                    FOR UPDATE SKIP LOCKED
                )
                RETURNING url;
            """)
            
            locked_urls = [row[0] for row in cursor.fetchall()]
            conn.commit()
            
            if not locked_urls:
                logger.info("üí§ No tasks found. Finished.")
                break

            try:
                # --- 2. –ó–ë–ò–†–ê–Ñ–ú–û –î–ê–ù–Ü (–û–ù–û–í–õ–ï–ù–û) ---
                # –î–æ–¥–∞—î–º–æ —á–∞—Å (prep/cook/total), —â–æ–± AI –∫—Ä–∞—â–µ –æ—Ü—ñ–Ω–∏–≤ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
                cursor.execute("""
                    SELECT r.id, r.title, r.original_url,
                           r.prep_time_min, r.cook_time_min,  -- üî• –ë–µ—Ä–µ–º–æ —á–∞—Å
                           COALESCE(string_agg(p.name, ', '), '') as ingredients_text
                    FROM recipes r
                    LEFT JOIN recipe_ingredients ri ON r.id = ri.recipe_id
                    LEFT JOIN products p ON ri.product_id = p.id
                    WHERE r.original_url = ANY(%s)
                    GROUP BY r.id
                """, (locked_urls,))
                
                rows = cursor.fetchall()
                
                recipes_input = []
                url_map = {} 

                for r in rows:
                    r_id, r_title, r_url, r_prep, r_cook, r_ing = r # –†–æ–∑–ø–∞–∫–æ–≤—É—î–º–æ –Ω–æ–≤—ñ –ø–æ–ª—è
                    
                    # –§–æ—Ä–º—É—î–º–æ —Ä—è–¥–æ–∫ —á–∞—Å—É –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É AI
                    time_info = ""
                    if r_prep or r_cook:
                        time_info = f"(Prep: {r_prep or 0}m, Cook: {r_cook or 0}m)"

                    recipes_input.append({
                        "id": r_id, 
                        "title": r_title,
                        "time": time_info, # –î–æ–¥–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –ø—Ä–æ —á–∞—Å
                        "ingredients": r_ing[:400] 
                    })
                    url_map[r_id] = r_url

                if not recipes_input:
                    cursor.execute("UPDATE recipe_queue SET status='TAGGING_ERROR', error_message='Missing in DB' WHERE url = ANY(%s)", (locked_urls,))
                    conn.commit()
                    continue

                # --- 3. –ü–†–û–ú–ü–¢ (–ó –î–ò–ù–ê–ú–Ü–ß–ù–ò–ú–ò –°–í–Ø–¢–ê–ú–ò) ---
                prompt = f"""
                –¢–∏ ‚Äî —à–µ—Ñ-–∫—É—Ö–∞—Ä-–∞–Ω–∞–ª—ñ—Ç–∏–∫ –∑ –£–∫—Ä–∞—ó–Ω–∏. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ö–õ–ê–°–ò–§–Ü–ö–ê–¶–Ü–Ø —Ä–µ—Ü–µ–ø—Ç—ñ–≤.
                –ê–Ω–∞–ª—ñ–∑—É–π —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –°–£–í–û–†–û. –ù–µ –¥–æ–ø—É—Å–∫–∞–π –ø–æ–º–∏–ª–æ–∫ —É –¥—ñ—î—Ç–∞—Ö.

                # –ó–ê–í–î–ê–ù–ù–Ø 1: –í–∏–∑–Ω–∞—á–∏—Ç–∏ "difficulty" (int):
                1 ‚Äî –õ–µ–≥–∫–æ (–ø—Ä–æ—Å—Ç–µ –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è, –º–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—ñ–≤, –¥–æ 30-40 —Ö–≤).
                2 ‚Äî –°–µ—Ä–µ–¥–Ω—å–æ (—Ç–∏–ø–æ–≤–∞ –¥–æ–º–∞—à–Ω—è —Å—Ç—Ä–∞–≤–∞, —Å—É–ø–∏, –¥—Ä—É–≥—ñ —Å—Ç—Ä–∞–≤–∏).
                3 ‚Äî –°–∫–ª–∞–¥–Ω–æ (–¥—Ä—ñ–∂–¥–∂–æ–≤–µ —Ç—ñ—Å—Ç–æ, —Å–∫–ª–∞–¥–Ω—ñ —Ç–æ—Ä—Ç–∏, —á–∞—Å > 2 –≥–æ–¥–∏–Ω, –±–∞–≥–∞—Ç–æ –µ—Ç–∞–ø—ñ–≤).

                # –ó–ê–í–î–ê–ù–ù–Ø 2: –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ "tags_grouped" (–£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é):

                ### dish_type (–û–ë–ï–†–ò 1‚Äì2):
                [–°—É–ø, –°–∞–ª–∞—Ç, –û—Å–Ω–æ–≤–Ω–∞ —Å—Ç—Ä–∞–≤–∞, –î–µ—Å–µ—Ä—Ç, –í–∏–ø—ñ—á–∫–∞, –ó–∞–∫—É—Å–∫–∞, –ù–∞–ø—ñ–π, –°–æ—É—Å, –ö–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è]
                * –ú–∞–π–æ–Ω–µ–∑, –°–º–µ—Ç–∞–Ω–∞, –ê–¥–∂–∏–∫–∞, –ó–∞–ø—Ä–∞–≤–∫–∞ -> "–°–æ—É—Å".
                * –ù–∞–ø–æ—ó (—á–∞–π, —Å–º—É–∑—ñ, –∫–æ–∫—Ç–µ–π–ª—å, –∫–æ–º–ø–æ—Ç) -> "–ù–∞–ø—ñ–π".
                * –•–ª—ñ–±, –ø–∏—Ä–æ–≥–∏, –º–ª–∏–Ω—Ü—ñ, –ø—ñ—Ü–∞ -> "–í–∏–ø—ñ—á–∫–∞".

                ### cuisine (1‚Äì2):
                [–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞, –Ñ–≤—Ä–æ–ø–µ–π—Å—å–∫–∞, –Ü—Ç–∞–ª—ñ–π—Å—å–∫–∞, –ê–∑—ñ–π—Å—å–∫–∞, –ì—Ä—É–∑–∏–Ω—Å—å–∫–∞, –ê–º–µ—Ä–∏–∫–∞–Ω—Å—å–∫–∞, –°—Ö—ñ–¥–Ω–∞]
                * –ë–æ—Ä—â, –≤–∞—Ä–µ–Ω–∏–∫–∏, –¥–µ—Ä—É–Ω–∏, –≥–æ–ª—É–±—Ü—ñ, —Å–∏—Ä–Ω–∏–∫–∏ -> "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞".
                * –ü—ñ—Ü–∞, –ø–∞—Å—Ç–∞ -> "–Ü—Ç–∞–ª—ñ–π—Å—å–∫–∞".
                * –•–∞—á–∞–ø—É—Ä—ñ, —Ö—ñ–Ω–∫–∞–ª—ñ -> "–ì—Ä—É–∑–∏–Ω—Å—å–∫–∞".
                * –Ø–∫—â–æ –Ω–µ –æ—á–µ–≤–∏–¥–Ω–æ -> "–Ñ–≤—Ä–æ–ø–µ–π—Å—å–∫–∞".

                ### meal_type (–û–ë–ï–†–ò –í–Ü–î–ü–û–í–Ü–î–ù–ï):
                [–°–Ω—ñ–¥–∞–Ω–æ–∫, –û–±—ñ–¥, –í–µ—á–µ—Ä—è, –ü–µ—Ä–µ–∫—É—Å, –°–≤—è—Ç–∫–æ–≤–∏–π —Å—Ç—ñ–ª]
                * –°–æ–ª–æ–¥–∫–µ/–í–∏–ø—ñ—á–∫–∞/–°–∏—Ä–Ω–∏–∫–∏ -> "–ü–µ—Ä–µ–∫—É—Å" –∞–±–æ "–°–Ω—ñ–¥–∞–Ω–æ–∫".
                * –°—É–ø–∏ -> "–û–±—ñ–¥".

                ### diet (–£–í–ê–ì–ê! –ß–ò–¢–ê–ô –°–¢–û–ü-–°–õ–û–í–ê –£–í–ê–ñ–ù–û):
                [–í–µ–≥–∞–Ω, –í–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–µ, –ë–µ–∑ –≥–ª—é—Ç–µ–Ω—É, –ö–µ—Ç–æ, –ë–µ–∑ —Ü—É–∫—Ä—É, –ü—ñ—Å–Ω–µ]
                
                ‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê –í–ò–ö–õ–Æ–ß–ï–ù–ù–Ø (–Ø–∫—â–æ —î —Ö–æ—á –æ–¥–∏–Ω —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç –∑—ñ —Å–ø–∏—Å–∫—É —Å—Ç–æ–ø-—Å–ª—ñ–≤ ‚Äî –¢–ï–ì –ó–ê–ë–û–†–û–ù–ï–ù–û):
                
                1. "–í–µ–≥–∞–Ω" (–¢—ñ–ª—å–∫–∏ —Ä–æ—Å–ª–∏–Ω–Ω–µ): 
                   ‚õîÔ∏è –ù–Ü: –ú'—è—Å–æ, –†–∏–±–∞, –Ø–π—Ü—è, –ú–µ–¥, –ñ–µ–ª–∞—Ç–∏–Ω.
                   ‚õîÔ∏è –ù–Ü –ú–û–õ–û–ß–¶–Ü: –°–∏—Ä, –ú–æ–ª–æ–∫–æ, –°–º–µ—Ç–∞–Ω–∞, –í–µ—Ä—à–∫–∏, –ú–∞—Å–ª–æ, –ö–µ—Ñ—ñ—Ä, –ô–æ–≥—É—Ä—Ç.
                
                2. "–ü—ñ—Å–Ω–µ" (Fasting): 
                   ‚õîÔ∏è –ù–Ü –ú'–Ø–°–£: –°–≤–∏–Ω–∏–Ω–∞, –Ø–ª–æ–≤–∏—á–∏–Ω–∞, –ö—É—Ä–∫–∞, –Ü–Ω–¥–∏—á–∫–∞, –§–∞—Ä—à, –ö–æ–≤–±–∞—Å–∞, –°–∞–ª–æ, –®–∏–Ω–∫–∞.
                   ‚õîÔ∏è –ù–Ü –¢–í–ê–†–ò–ù–ù–û–ú–£: –Ø–π—Ü—è, –ú–æ–ª–æ–∫–æ, –°–º–µ—Ç–∞–Ω–∞, –°–∏—Ä, –ú–∞—Å–ª–æ, –í–µ—Ä—à–∫–∏, –ñ–µ–ª–∞—Ç–∏–Ω.
                   (‚úÖ –ú–µ–¥, –¶—É–∫–æ—Ä, –û–ª—ñ—è - –î–æ–∑–≤–æ–ª–µ–Ω—ñ).
                
                3. "–í–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫–µ": 
                   ‚õîÔ∏è –ù–Ü: –ú'—è—Å–æ (–°–≤–∏–Ω–∏–Ω–∞, –Ø–ª–æ–≤–∏—á–∏–Ω–∞, –ö—É—Ä–∫–∞, –§–∞—Ä—à, –°–∞–ª–æ), –†–∏–±–∞, –ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏, –ñ–µ–ª–∞—Ç–∏–Ω.
                   (‚úÖ –Ø–π—Ü—è —Ç–∞ –ú–æ–ª–æ–∫–æ - –î–æ–∑–≤–æ–ª–µ–Ω—ñ).

                4. "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω—É": 
                   ‚õîÔ∏è –ù–Ü: –ü—à–µ–Ω–∏—á–Ω–µ –±–æ—Ä–æ—à–Ω–æ, –•–ª—ñ–±, –°—É—Ö–∞—Ä—ñ, –ú–∞–∫–∞—Ä–æ–Ω–∏ (–∑ –ø—à–µ–Ω–∏—Ü—ñ), –ú–∞–Ω–∫–∞, –ö—É—Å–∫—É—Å, –ë—É–ª–≥—É—Ä.
                
                5. "–ö–µ—Ç–æ": 
                   ‚õîÔ∏è –ù–Ü: –¶—É–∫–æ—Ä, –ú–µ–¥, –ö–∞—Ä—Ç–æ–ø–ª—è, –ë–æ—Ä–æ—à–Ω–æ, –ö—Ä—É–ø–∏, –†–∏—Å, –§—Ä—É–∫—Ç–∏, –°—É—Ö–æ—Ñ—Ä—É–∫—Ç–∏.
                
                6. "–ë–µ–∑ —Ü—É–∫—Ä—É": 
                   ‚õîÔ∏è –ù–Ü: –¶—É–∫–æ—Ä, –ü—É–¥—Ä–∞, –°–∏—Ä–æ–ø, –ú–µ–¥, –ó–≥—É—â–µ–Ω–µ –º–æ–ª–æ–∫–æ, –®–æ–∫–æ–ª–∞–¥ (–∑–≤–∏—á–∞–π–Ω–∏–π).

                ### occasion (–û–ë–ï–†–ò –ó–Ü –°–ü–ò–°–ö–£ –ù–ò–ñ–ß–ï):
                –û–ë–ï–†–ò –í–Ü–î–ü–û–í–Ü–î–ù–Ü –¢–ï–ì–ò –ó–Ü –°–ü–ò–°–ö–£: [{occasions_prompt_list}].
                
                –ê–°–û–¶–Ü–ê–¢–ò–í–ù–Ü –ü–†–ê–í–ò–õ–ê (–°–¢–ê–í –¢–ï–ì, –Ø–ö–©–û –†–ï–¶–ï–ü–¢ –ü–Ü–î–•–û–î–ò–¢–¨ –ó–ê –°–£–¢–¢–Æ –ê–ë–û –Ü–ù–ì–†–ï–î–Ü–Ñ–ù–¢–ê–ú–ò):
                1. "–†—ñ–∑–¥–≤–æ" / "–©–µ–¥—Ä–∏–π –í–µ—á—ñ—Ä": –ö—É—Ç—è, —É–∑–≤–∞—Ä, –ø–∞–º–ø—É—à–∫–∏, —à—Ç–æ–ª–µ–Ω, –∫–∞—á–∫–∞, 12 —Å—Ç—Ä–∞–≤.
                2. "–ù–æ–≤–∏–π –†—ñ–∫": –û–ª—ñ–≤'—î, –®—É–±–∞, —Ö–æ–ª–æ–¥–µ—Ü—å, —ñ–∫—Ä–∞, —Å–≤—è—Ç–∫–æ–≤—ñ —Ç–æ—Ä—Ç–∏.
                3. "–í–µ–ª–∏–∫–¥–µ–Ω—å": –ü–∞—Å–∫–∏, –∫—Ä–∞—à–∞–Ω–∫–∏, –±—É–∂–µ–Ω–∏–Ω–∞, –∫–æ–≤–±–∞—Å–∞, —Ö–æ–ª–æ–¥–µ—Ü—å.
                4. "–ú–∞—Å–ª—è–Ω–∞": –ú–õ–ò–ù–¶–Ü, –Ω–∞–ª–∏—Å–Ω–∏–∫–∏, –æ–ª–∞–¥–∫–∏.
                5. "–•–µ–ª–ª–æ–≤—ñ–Ω": –ì–ê–†–ë–£–ó, "—Å—Ç—Ä–∞—à–Ω–∏–π" –¥–µ–∫–æ—Ä.
                6. "–Ø–±–ª—É—á–Ω–∏–π –°–ø–∞—Å": –Ø–ë–õ–£–ö–ê (–ø–∏—Ä–æ–≥–∏, –∑–∞–ø–µ—á–µ–Ω—ñ).
                7. "–ú–µ–¥–æ–≤–∏–π –°–ø–∞—Å": –ú–ï–î, –ú–ê–ö (—à—É–ª–∏–∫–∏, –º–µ–¥—ñ–≤–Ω–∏–∫–∏).
                8. "–ì–æ—Ä—ñ—Ö–æ–≤–∏–π –°–ø–∞—Å": –ì–û–†–Ü–•–ò, –≤–∏–ø—ñ—á–∫–∞.
                9. "–ü—ñ–∫–Ω—ñ–∫ —Ç–∞ –ì—Ä–∏–ª—å": –®–∞—à–ª–∏–∫, –≥—Ä–∏–ª—å, –º–∞–Ω–≥–∞–ª, –±—É—Ä–≥–µ—Ä–∏, –ª–∞–≤–∞—à.
                10. "–°–µ–∑–æ–Ω –∫–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—ó": –ë–∞–Ω–∫–∏, –º–∞—Ä–∏–Ω—É–≤–∞–Ω–Ω—è, –≤–∞—Ä–µ–Ω–Ω—è, –ª–µ—á–æ.
                11. "–î–µ–Ω—å –ó–∞–∫–æ—Ö–∞–Ω–∏—Ö": –®–æ–∫–æ–ª–∞–¥, –ø–æ–ª—É–Ω–∏—Ü—è, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∞ –≤–µ—á–µ—Ä—è, —Å–µ—Ä—Ü—è.
                12. "–î–µ–Ω—å –ú–∏–∫–æ–ª–∞—è": –ü—Ä—è–Ω–∏–∫–∏ (–º–∏–∫–æ–ª–∞–π—á–∏–∫–∏), –ø–µ—á–∏–≤–æ.
                13. "–í–æ–¥–æ—Ö—Ä–µ—â–∞": –ü—ñ—Å–Ω–µ, –≥–æ–ª–æ–¥–Ω–∞ –∫—É—Ç—è.
                14. "–°–≤—è—Ç–æ –í–µ—Å–Ω–∏": –õ–µ–≥–∫—ñ —Å–∞–ª–∞—Ç–∏ (—Ä–µ–¥–∏—Å, –∑–µ–ª–µ–Ω—å).
                15. "–Ü–≤–∞–Ω–∞ –ö—É–ø–∞–ª–∞": –¢—Ä–∞–≤'—è–Ω—ñ —á–∞—ó, –∫—É–ª—ñ—à.
                16. "–î–µ–Ω—å –ù–µ–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ": –ë–æ—Ä—â, –≤–∞—Ä–µ–Ω–∏–∫–∏ (–Ω–∞—Ü. –∫—É—Ö–Ω—è).
                17. "–î–µ–Ω—å –ó–Ω–∞–Ω—å": –ö–µ–∫—Å–∏, –ø—ñ—Ü–∞, –ø–µ—Ä–µ–∫—É—Å–∏ –¥—ñ—Ç—è–º.
                18. "–ü–æ–∫—Ä–æ–≤–∞": –ö–æ–∑–∞—Ü—å–∫—ñ —Å—Ç—Ä–∞–≤–∏, –≥–∞—Ä–±—É–∑.
                19. "–í–µ–ª–∏–∫–∏–π –ü—ñ—Å—Ç": –°—Ç—Ä–æ–≥–æ –í–µ–≥–∞–Ω (–∞–ª–µ —Å–∏—Ç–Ω–µ).
                20. "–†—ñ–∑–¥–≤—è–Ω–∏–π –ü—ñ—Å—Ç": –ü—ñ—Å–Ω–µ + –†–∏–±–∞.

                –Ø–∫—â–æ —Ä–µ—Ü–µ–ø—Ç –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å ‚Äî –ø–æ–≤–µ—Ä–Ω–∏ [].

                ---
                # –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ:
                {json.dumps(recipes_input, ensure_ascii=False)}

                # –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç JSON (Strict):
                [
                  {{
                    "id": 123,
                    "difficulty": 2,
                    "tags_grouped": {{
                      "dish_type": ["–û—Å–Ω–æ–≤–Ω–µ"],
                      "cuisine": ["–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞"],
                      "meal_type": ["–í–µ—á–µ—Ä—è"],
                      "diet": ["–ü—ñ—Å–Ω–µ"],
                      "occasion": ["–†—ñ–∑–¥–≤–æ"]
                    }}
                  }}
                ]
                """
                logger.info(f"Prompt to AI {prompt}")
                # --- 4. AI –ó–ê–ü–ò–¢ ---
                ai_response = ask_ai_json(prompt)
                
                if not ai_response or not isinstance(ai_response, list):
                    raise ValueError("Invalid AI JSON")
                
                # --- 5. –û–ë–†–û–ë–ö–ê ---
                updates_difficulty = [] 
                tag_ops = [] 
                processed_ids = set()

                for item in ai_response:
                    r_id = item.get("id")
                    if r_id not in url_map: continue

                    # ‚ö†Ô∏è –ë–µ—Ä–µ–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ —Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ –Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä
                    original_recipe = next((r for r in recipes_input if r["id"] == r_id), None)
                    ing_text_lower = original_recipe["ingredients"].lower() if original_recipe else ""

                    # A. –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
                    diff = item.get("difficulty")
                    if diff and isinstance(diff, int):
                        updates_difficulty.append((diff, r_id))

                    # B. –¢–µ–≥–∏
                    tags_grouped = item.get("tags_grouped", {})
                    for tag_type, tag_list in tags_grouped.items():
                        if not tag_list: continue
                        
                        # –í–ê–õ–Ü–î–ê–¶–Ü–Ø –î–Ü–Ñ–¢
                        if tag_type == "diet":
                            valid_list = []
                            for t in tag_list:
                                if validate_diet_tag(t, ing_text_lower):
                                    valid_list.append(t)
                                else:
                                    # üëá –î–û–î–ê–Ñ–ú–û –õ–û–ì –¢–£–¢
                                    # –¶–µ —Å–ø—Ä–∞—Ü—é—î, —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä–Ω—É–ª–∞ False (–∑–Ω–∞–π—à–ª–∞ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ —Å–ª–æ–≤–æ)
                                    logger.warning(
                                        f"üõ°Ô∏è SafetyNet: –†–µ—Ü–µ–ø—Ç {r_id} –≤—Ç—Ä–∞—Ç–∏–≤ —Ç–µ–≥ '{t}'. "
                                        f"–ü—Ä–∏—á–∏–Ω–∞: –∑–Ω–∞–π–¥–µ–Ω–æ —Å—Ç–æ–ø-—Å–ª–æ–≤–æ –≤ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞—Ö."
                                    )
                                    # –ú–æ–∂–Ω–∞ –Ω–∞–≤—ñ—Ç—å –≤–∏–≤–µ—Å—Ç–∏ —à–º–∞—Ç–æ–∫ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –æ—á–∏–º–∞:
                                    # logger.info(f"   –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏: {ing_text_lower[:100]}...")
                            tag_list = valid_list

                        for t_name in tag_list:
                            clean_name = str(t_name).strip()
                            tag_ops.append((clean_name, tag_type, r_id))
                    
                    processed_ids.add(r_id)

                # --- 6. –ó–ê–ü–ò–° –£ –ë–î ---
                
                # 1. –û–Ω–æ–≤–ª—é—î–º–æ –¢–Ü–õ–¨–ö–ò difficulty (—ñ–Ω—à–µ –≤–∂–µ —î)
                if updates_difficulty:
                    cursor.executemany("""
                        UPDATE recipes SET difficulty=%s WHERE id=%s
                    """, updates_difficulty)

                # 2. –í—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–æ–≤—ñ —Ç–µ–≥–∏ (—è–∫—â–æ AI –ø—Ä–∏–¥—É–º–∞–≤ –Ω–æ–≤—É "cuisine")
                # –î–ª—è occasion –º–∏ –±–µ—Ä–µ–º–æ –∑ –ø—Ä–æ–º–ø—Ç–∞, –∞–ª–µ –ø—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫ UPSERT
                unique_tags = {(t[0], t[1]) for t in tag_ops} 
                if unique_tags:
                    cursor.executemany("""
                        INSERT INTO tags (name, type) 
                        VALUES (%s, %s)
                        ON CONFLICT (name) DO UPDATE 
                        SET type = EXCLUDED.type 
                        WHERE tags.type = 'general';
                    """, list(unique_tags))

                # 3. –õ—ñ–Ω–∫—É—î–º–æ —Ç–µ–≥–∏
                all_tag_names = list({t[0] for t in tag_ops})
                tag_id_map = {}
                if all_tag_names:
                    cursor.execute("SELECT name, id FROM tags WHERE name = ANY(%s)", (all_tag_names,))
                    tag_id_map = {row[0]: row[1] for row in cursor.fetchall()}

                links_to_insert = []
                for t_name, _, r_id in tag_ops:
                    if t_name in tag_id_map:
                        links_to_insert.append((r_id, tag_id_map[t_name]))
                
                if links_to_insert:
                    cursor.executemany("""
                        INSERT INTO recipe_tags (recipe_id, tag_id) 
                        VALUES (%s, %s) 
                        ON CONFLICT DO NOTHING;
                    """, links_to_insert)

                # 7. –ß–ï–†–ì–ê
                success_urls = [url_map[rid] for rid in processed_ids]
                failed_urls = list(set(locked_urls) - set(success_urls))

                if success_urls:
                    cursor.execute("UPDATE recipe_queue SET status='TAGGING_DONE', updated_at=NOW() WHERE url = ANY(%s)", (success_urls,))
                
                if failed_urls:
                    cursor.execute("UPDATE recipe_queue SET status='TAGGING_ERROR', error_message='AI missed item' WHERE url = ANY(%s)", (failed_urls,))

                conn.commit()
                logger.info(f"‚úÖ Batch processed: {len(success_urls)} OK")

            except Exception as e:
                conn.rollback()
                logger.error(f"‚ùå Batch Failed: {e}")
                cursor.execute("UPDATE recipe_queue SET status='TAGGING_ERROR', error_message=%s WHERE url = ANY(%s)", (str(e)[:200], locked_urls))
                conn.commit()

    worker_task.expand(worker_id=list(range(CONCURRENCY)))

recipe_enricher()